generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Empleado
model Employee {
  id         String @id @default(cuid())
  firstName  String
  lastName   String
  email      String @unique
  department String
  position   String

  identityCard String   @unique
  birthDate    DateTime
  address      String
  phone        String
  hireDate     DateTime
  contractType String
  civilStatus  String

  bankName      String?
  accountNumber String?
  accountType   String? // "Ahorros", "Corriente"

  // Salario encriptado en la base de datos
  // Se almacena como: salt:iv:authTag:encryptedData
  salary String // Valor encriptado

  password String // Contraseña hasheada
  role     String @default("employee") // Rol: 'admin' | 'employee'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vacationDays Int @default(15)

  // Terminación (RF-REP-002)
  isActive    Boolean   @default(true)
  exitDate    DateTime?
  exitReason  String?
  exitType    String?   // "VOLUNTARY", "INVOLUNTARY"

  // Relaciones
  skills        Skill[]
  workHistory   WorkHistory[]
  contracts     Contract[]
  documents     Document[]
  attendance    Attendance[]
  schedules     EmployeeSchedule[]
  absences      AbsenceRequest[]
  PayrollDetail PayrollDetail[]
  benefits      EmployeeBenefit[]

  // Evauluations
  evaluations   EmployeeEvaluation[] // Evaluaciones que recibe el empleado
  reviewedEvaluations EvaluationReviewer[] // Evaluaciones que realiza el empleado (como revisor)
  goals         EmployeeGoal[]
  postedVacancies JobVacancy[]
  interviews    Interview[]
  candidateEvaluations CandidateEvaluation[]

  @@index([email])
  @@index([department])
  @@map("employees")
}

model EmployeeGoal {
  id          String   @id @default(uuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  
  // SMART Checks
  metric      String   @default("Manual") // How it is measured
  targetValue Float    // The 'M' in SMART (Measurable)
  currentValue Float   @default(0)
  unit        String   @default("%") // %, USD, Units
  
  deadline    DateTime // The 'T' in SMART (Time-bound)
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  progress    Float    @default(0) // 0-100 percentage calculated
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([employeeId])
  @@map("employee_goals")
}

model AbsenceRequest {
  id        String   @id @default(cuid())
  type      String // "Enfermedad", "Vacaciones", "Personal", "Otro"
  startDate DateTime
  endDate   DateTime
  reason    String   @db.Text
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED

  evidenceUrl String? // Path to uploaded file

  adminComment String? // Comentario del admin al aprobar/rechazar

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@map("absence_requests")
}

model Attendance {
  id          String    @id @default(cuid())
  date        DateTime
  checkIn     DateTime
  checkOut    DateTime?
  workedHours Float?
  status      String

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendance")
}

model Shift {
  id        String @id @default(cuid())
  name      String // "Mañana", "Tarde", "Noche"
  startTime String // "08:00"
  endTime   String // "17:00"

  schedules EmployeeSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shifts")
}

model EmployeeSchedule {
  id String @id @default(cuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  shiftId String
  shift   Shift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime? // Null significa indefinido

  daysOfWeek String // JSON ["Lunes", "Martes", ...] stored as string for simplicity in SQLite/Postgres compatibility if needed, or better Prisma String[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([shiftId])
  @@map("employee_schedules")
}

model Skill {
  id    String @id @default(cuid())
  name  String
  level String // Beginner, Intermediate, Advanced, Expert

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("skills")
}

model WorkHistory {
  id          String    @id @default(cuid())
  company     String
  position    String
  startDate   DateTime
  endDate     DateTime?
  description String?   @db.Text

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("work_history")
}

model AuditLog {
  id          String   @id @default(cuid())
  entity      String // "Employee"
  entityId    String
  action      String // "UPDATE", "CREATE"
  performedBy String // User name or ID
  details     String   @db.Text // JSON string of changes
  timestamp   DateTime @default(now())

  @@index([entityId])
  @@map("audit_logs")
}

model Contract {
  id          String    @id @default(cuid())
  type        String // "Indefinido", "Temporal", "Por Obra", etc.
  startDate   DateTime
  endDate     DateTime?
  salary      Float
  clauses     String?   @db.Text
  documentUrl String? // Path to PDF
  status      String    @default("Active") // Active, Expired, Terminated

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@map("contracts")
}

model Document {
  id           String    @id @default(cuid())
  type         String // "DNI", "Licencia", "Certificado", "Otro"
  documentUrl  String // Filename
  originalName String?
  mimeType     String?
  expiryDate   DateTime?

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@map("documents")
}

model PayrollConfig {
  id          String @id @default(cuid())
  workingDays Int    @default(30)
  currency    String @default("USD")

  validFrom DateTime @default(now())
  isActive  Boolean  @default(true)

  items PayrollItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payroll_configs")
}

model PayrollItem {
  id   String @id @default(cuid())
  name String
  type String // "EARNING" (Ingreso), "DEDUCTION" (Egreso)

  isMandatory Boolean @default(false)

  // Si es porcentaje, ej: 9.45 para 9.45%
  percentage Float?

  // Si es valor fijo, ej: 20.00
  fixedValue Float?

  configId String
  config   PayrollConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([configId])
  @@map("payroll_items")
}

model Payroll {
  id String @id @default(cuid())

  period  DateTime // Start of month usually
  endDate DateTime // End of period

  status String @default("DRAFT") // DRAFT, ISSUED, PAID

  totalAmount Float

  details PayrollDetail[]
  
  paymentDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payrolls")
}

model PayrollDetail {
  id String @id @default(cuid())

  payrollId String
  payroll   Payroll @relation(fields: [payrollId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Base Data
  baseSalary Float
  workedDays Int

  // Overtime
  overtimeHours  Float
  overtimeAmount Float

  // Variable JSONs using simple String (JSON.stringify)
  bonuses    String // JSON string: [{name, amount}, ...]
  deductions String // JSON string: [{name, amount}, ...]

  netSalary Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([payrollId])
  @@index([employeeId])
  @@map("payroll_details")
}

model EmployeeBenefit {
  id        String @id @default(cuid())
  name      String
  amount    Float
  
  type      String // "BONUS", "INCENTIVE", "ALLOWANCE"
  frequency String // "ONE_TIME", "RECURRING"
  
  status    String @default("ACTIVE") // ACTIVE, PROCESSED, CANCELLED

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@map("employee_benefits")
}

model EvaluationTemplate {
  id           String   @id @default(cuid())
  title        String
  description  String?
  period       String
  instructions String?  @db.Text
  
  // JSON strings for flexibility
  criteria     String   @db.Text // JSON: [{ name, description, weight, type }]
  scale        String   @db.Text // JSON: { type: "numeric", min: 1, max: 5, labels: {} }
  
  isActive     Boolean  @default(true)
  
  evaluations  EmployeeEvaluation[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("evaluation_templates")
}

model EmployeeEvaluation {
  id           String   @id @default(cuid())
  
  templateId   String
  template     EvaluationTemplate @relation(fields: [templateId], references: [id])
  
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  startDate    DateTime
  endDate      DateTime
  
  status       String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, REVIEWED
  
  // Results
  finalScore   Float?
  feedback     String?  @db.Text
  
  reviewers    EvaluationReviewer[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([templateId])
  @@index([employeeId])
  @@map("employee_evaluations")
}

model EvaluationReviewer {
  id           String   @id @default(cuid())
  
  evaluationId String
  evaluation   EmployeeEvaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  reviewerId   String
  reviewer     Employee @relation(fields: [reviewerId], references: [id])
  
  status       String   @default("PENDING") // PENDING, COMPLETED
  
  // The actual responses
  responses    String?  @db.Text // JSON: { criteriaId: score, comment: string }
  comments     String?  @db.Text
  
  score        Float?
  
  completedAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([evaluationId])
  @@index([reviewerId])
  @@map("evaluation_reviewers")
}

model JobVacancy {
  id          String   @id @default(cuid())
  title       String
  department  String
  
  description String   @db.Text
  requirements String  @db.Text // Can be a rich text or bullet points
  benefits    String?  @db.Text
  
  salaryMin   Float?
  salaryMax   Float?
  currency    String   @default("USD")
  
  location    String
  employmentType String // Full-time, Part-time, Contract
  
  deadline    DateTime
  status      String   @default("OPEN") // OPEN, CLOSED
  
  postedById  String
  postedBy    Employee @relation(fields: [postedById], references: [id])
  
  applications JobApplication[]
  
  evaluationCriteria Json? // ["Technical", "Communication", "Experience"]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([postedById])
  @@map("job_vacancies")
}

model JobApplication {
  id          String   @id @default(cuid())
  
  vacancyId   String
  vacancy     JobVacancy @relation(fields: [vacancyId], references: [id], onDelete: Cascade)
  
  firstName   String
  lastName    String
  email       String
  phone       String
  
  resumeUrl   String   // Path to CV
  coverLetter String?  @db.Text
  
  status      String   @default("PENDING") // PENDING, REVIEWING, INTERVIEW, REJECTED, HIRED
  
  notes       ApplicationNote[] // HR Notes
  interviews  Interview[]
  evaluations CandidateEvaluation[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([vacancyId])
  @@map("job_applications")
}

model ApplicationNote {
  id            String   @id @default(cuid())
  applicationId String
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  content       String   @db.Text
  createdBy     String   // Name of HR user
  createdById   String
  
  createdAt     DateTime @default(now())
  
  @@index([applicationId])
  @@map("application_notes")
}

model Interview {
  id            String   @id @default(cuid())
  applicationId String
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  date          DateTime
  type          String   // 'PRESENTIAL', 'VIRTUAL'
  location      String?  // Address or Link
  interviewerId String
  interviewer   Employee @relation(fields: [interviewerId], references: [id])
  
  notes         String?
  status        String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  
  createdAt     DateTime @default(now())
  
  @@index([applicationId])
  @@index([interviewerId])
  @@map("interviews")
}

model CandidateEvaluation {
  id            String   @id @default(cuid())
  applicationId String
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  evaluatorId   String
  evaluator     Employee @relation(fields: [evaluatorId], references: [id])
  
  ratings       Json     // { "Technique": 5, "Soft Skills": 4 }
  comments      String   @db.Text
  recommendation String  // "HIRE", "NO_HIRE", "MAYBE"
  overallScore  Float
  
  createdAt     DateTime @default(now())
  
  @@index([applicationId])
  @@map("candidate_evaluations")
}
